<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PriceNow | Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø°ÙƒÙŠ Ù„Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø°Ù‡Ø¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@300;400;700;900&display=swap');
        body { font-family: 'Noto Sans Arabic', sans-serif; background-color: #050505; color: #f1f5f9; direction: rtl; }
        .gold-border { border: 1px solid rgba(234, 179, 8, 0.2); background: linear-gradient(145deg, #111 0%, #050505 100%); }
        .price-card-hero { background: linear-gradient(135deg, #1a1500 0%, #000 100%); border: 1px solid #d4af3733; }
        .ticker-bar { background: #d4af37; color: #000; font-weight: 900; overflow: hidden; white-space: nowrap; }
        .ticker-content { display: inline-block; animation: scroll 40s linear infinite; }
        @keyframes scroll { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .indicator-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.4; transform: scale(1.2); } }
        .bell-ring { animation: ring 2s ease infinite; }
        @keyframes ring { 0%, 25%, 100% { transform: rotate(0); } 5%, 15% { transform: rotate(15deg); } 10%, 20% { transform: rotate(-15deg); } }
    </style>
</head>
<body class="min-h-screen pb-20">

    <header class="bg-black border-b border-zinc-800 py-4 px-6 sticky top-0 z-50">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-yellow-500 rounded-lg flex items-center justify-center text-black shadow-[0_0_15px_rgba(234,179,8,0.4)]">
                    <i class="fas fa-bolt text-xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter text-white">Price<span class="text-yellow-500">Now</span></h1>
                    <p class="text-[10px] text-zinc-500 font-bold uppercase tracking-widest leading-none">Persistent Gold Terminal</p>
                </div>
            </div>
            
            <div class="flex items-center gap-4">
                <button onclick="requestNotificationPermission()" id="perm-btn" class="text-[10px] font-bold bg-zinc-800 px-3 py-1 rounded-full border border-zinc-700 hover:bg-zinc-700 transition">
                    ØªÙØ¹ÙŠÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ””
                </button>
                <button id="notification-bell" class="w-10 h-10 bg-zinc-900 rounded-full flex items-center justify-center text-zinc-400 hover:text-yellow-500 transition border border-zinc-800 relative">
                    <i class="fas fa-bell"></i>
                    <span id="alert-badge" class="hidden absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full border-2 border-black"></span>
                </button>
            </div>
        </div>
    </header>

    <div class="ticker-bar py-2 text-[10px] sm:text-xs uppercase">
        <div class="ticker-content">
            â€¢ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø°ÙƒÙŠ Ù…ÙØ¹Ù„ Ø§Ù„Ø¢Ù†: Ø³ØªØµÙ„Ùƒ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø­ØªÙ‰ Ù„Ùˆ ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆÙ‚Ø¹ â€¢ Ø¹ÙŠØ§Ø± 21 ÙŠØ³Ø¬Ù„ Ø§Ø³ØªÙ‚Ø±Ø§Ø±Ø§Ù‹ â€¢ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙˆØ±ÙŠØ© ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚ â€¢ 
        </div>
    </div>

    <main class="max-w-6xl mx-auto p-6">
        
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 mb-10">
            <!-- Main Display -->
            <div class="lg:col-span-8 price-card-hero rounded-[2.5rem] p-6 sm:p-10 relative overflow-hidden shadow-2xl">
                <div class="relative z-10">
                    <span class="text-yellow-500 font-bold text-[10px] bg-yellow-500/10 px-3 py-1 rounded-full border border-yellow-500/20">Ø¹ÙŠØ§Ø± 21 - Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</span>
                    <div class="flex items-baseline gap-4 mt-4">
                        <span id="price-21k" class="text-7xl sm:text-8xl font-black text-white tracking-tighter leading-none">7,300</span>
                        <span class="text-2xl font-bold text-zinc-500">Ø¬.Ù…</span>
                    </div>
                </div>
            </div>

            <!-- Schedule Card -->
            <div class="lg:col-span-4 bg-zinc-900 border border-zinc-800 rounded-[2.5rem] p-8">
                <h4 class="text-xl font-black text-white mb-6 flex items-center gap-2">
                    <i class="fas fa-clock text-yellow-500"></i>
                    ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© (Native)
                </h4>
                <div class="space-y-4">
                    <div class="flex gap-2">
                        <select id="schedule-karat" class="flex-1 bg-black border border-zinc-800 p-4 rounded-xl text-white font-bold outline-none">
                            <option value="21">Ø¹ÙŠØ§Ø± 21</option>
                            <option value="24">Ø¹ÙŠØ§Ø± 24</option>
                            <option value="18">Ø¹ÙŠØ§Ø± 18</option>
                        </select>
                        <input type="number" id="schedule-minutes" value="5" min="1" class="w-20 bg-black border border-zinc-800 p-4 rounded-xl text-white font-black text-center outline-none">
                    </div>
                    
                    <button onclick="startBackgroundAlerts()" class="w-full bg-yellow-500 text-black py-4 rounded-xl font-black text-sm hover:scale-[1.02] active:scale-95 transition">
                        ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©
                    </button>

                    <div id="status-card" class="hidden bg-green-500/10 border border-green-500/20 p-4 rounded-2xl">
                        <span class="block text-[8px] text-green-500 font-black uppercase">Ø§Ù„Ø®Ø¯Ù…Ø© ØªØ¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©</span>
                        <p id="status-text" class="text-xs font-bold text-white mt-1">ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ„ 5 Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ø¹ÙŠØ§Ø± 21</p>
                        <button onclick="stopBackgroundAlerts()" class="mt-2 text-red-500 text-[10px] font-bold underline">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø®Ø¯Ù…Ø©</button>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 bg-yellow-500 text-black px-8 py-4 rounded-full font-black text-lg shadow-2xl z-[200] transform translate-y-32 transition-transform duration-500 flex items-center gap-4">
        <i class="fas fa-check-circle"></i>
        <span id="toast-message">ØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­!</span>
    </div>

    <!-- Service Worker Script Block -->
    <script id="sw-code" type="text/javascript">
        // This is the code that will be used for the Service Worker
        const swTemplate = `
        self.addEventListener('install', (e) => {
            self.skipWaiting();
        });

        self.addEventListener('activate', (e) => {
            e.waitUntil(clients.claim());
        });

        // Listen for messages from the website
        self.addEventListener('message', (event) => {
            if (event.data.type === 'START_ALERTS') {
                const { mins, karat } = event.data;
                setupTimer(mins, karat);
            }
            if (event.data.type === 'STOP_ALERTS') {
                if (self.alertTimer) clearInterval(self.alertTimer);
            }
        });

        function setupTimer(mins, karat) {
            if (self.alertTimer) clearInterval(self.alertTimer);
            
            // Initial call
            sendNotification(karat);

            self.alertTimer = setInterval(() => {
                sendNotification(karat);
            }, mins * 60000);
        }

        function sendNotification(karat) {
            // In a real world app, we would fetch live data here.
            // For the demo, we use the last known price sent from main thread or random volatility.
            const base = 7300;
            const price = base + Math.floor(Math.random() * 50);
            
            self.registration.showNotification("ØªØ­Ø¯ÙŠØ« Ø³Ø¹Ø± Ø§Ù„Ø°Ù‡Ø¨ Ù…Ù† PriceNow", {
                body: "Ø¹ÙŠØ§Ø± " + karat + " Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† " + price.toLocaleString('ar-EG') + " Ø¬.Ù…",
                icon: "https://cdn-icons-png.flaticon.com/512/261/261778.png",
                badge: "https://cdn-icons-png.flaticon.com/512/261/261778.png",
                tag: "gold-price-alert", // Overwrite old notification
                vibrate: [200, 100, 200]
            });
        }
        `;
    </script>

    <script>
        // --- Core Price Logic ---
        let currentPrice = 7300;
        setInterval(() => {
            currentPrice += (Math.random() - 0.5) * 5;
            document.getElementById('price-21k').innerText = Math.floor(currentPrice).toLocaleString('ar-EG');
        }, 2000);

        // --- Service Worker & Notification Logic ---
        async function requestNotificationPermission() {
            const permission = await Notification.requestPermission();
            if (permission === 'granted') {
                showToast("ØªÙ… Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù†! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªÙØ¹ÙŠÙ„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©.");
                document.getElementById('perm-btn').classList.add('hidden');
            } else {
                showToast("ÙŠØ±Ø¬Ù‰ Ù…Ù†Ø­ Ø§Ù„Ø¥Ø°Ù† Ù„ØªÙ„Ù‚ÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©.");
            }
        }

        async function initServiceWorker() {
            if ('serviceWorker' in navigator) {
                const blob = new Blob([document.getElementById('sw-code').textContent], { type: 'text/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                try {
                    const registration = await navigator.serviceWorker.register(swUrl);
                    console.log('SW Registered');
                    return registration;
                } catch (err) {
                    console.error('SW Registration Failed', err);
                }
            }
        }

        async function startBackgroundAlerts() {
            if (Notification.permission !== 'granted') {
                await requestNotificationPermission();
                if (Notification.permission !== 'granted') return;
            }

            const mins = document.getElementById('schedule-minutes').value;
            const karat = document.getElementById('schedule-karat').value;

            // Register/Get SW
            const registration = await initServiceWorker();
            
            // Send message to SW to start timer
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({
                    type: 'START_ALERTS',
                    mins: parseInt(mins),
                    karat: karat
                });

                document.getElementById('status-card').classList.remove('hidden');
                document.getElementById('status-text').innerText = `ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ„ ${mins} Ø¯Ù‚ÙŠÙ‚Ø© Ù„Ø¹ÙŠØ§Ø± ${karat}`;
                showToast("ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ© Ù†Ø´Ø·Ø© Ø§Ù„Ø¢Ù†");
            } else {
                // If controller is null, refresh is needed to activate SW
                showToast("Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…... ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©");
                location.reload(); 
            }
        }

        function stopBackgroundAlerts() {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'STOP_ALERTS' });
            }
            document.getElementById('status-card').classList.add('hidden');
            showToast("ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø®Ù„ÙÙŠØ©");
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            document.getElementById('toast-message').innerText = msg;
            toast.classList.remove('translate-y-32');
            setTimeout(() => toast.classList.add('translate-y-32'), 5000);
        }

        window.onload = () => {
            if (Notification.permission === 'granted') {
                document.getElementById('perm-btn').classList.add('hidden');
            }
            // Silent registration to prepare
            initServiceWorker();
        };
    </script>
</body>
</html>
